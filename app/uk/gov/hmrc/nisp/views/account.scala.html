@*
* Copyright 2016 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@import uk.gov.hmrc.nisp.utils.Constants
@import uk.gov.hmrc.nisp.views.formatting.{NispMoney, Time}
@import uk.gov.hmrc.play.views.formatting.Dates
@import uk.gov.hmrc.nisp.models.{SPSummaryModel, SPChartModel}
@import uk.gov.hmrc.nisp.services.ABService
@import uk.gov.hmrc.nisp.models.enums.ABTest._
@import uk.gov.hmrc.nisp.controllers.auth.NispUser
@import uk.gov.hmrc.play.partials.CachedStaticHtmlPartialRetriever
@import uk.gov.hmrc.nisp.models.enums.Scenario
@import uk.gov.hmrc.nisp.controllers.routes
@import uk.gov.hmrc.nisp.utils.Constants

@(
    nino: String,
    spSummary: SPSummaryModel,
    abTest: Option[ABTest],
    currentChart: SPChartModel,
    forecastChart: SPChartModel,
    authenticationProvider: String,
    isPertaxUrl:Boolean
)(implicit request: Request[_], user: NispUser, partialRetriever: CachedStaticHtmlPartialRetriever)


@analyticsAdditionalJs = {
    ga('set', {
        'dimension7':  '@spSummary.contextMessage.getOrElse("")',
        'dimension8':  '@spSummary.forecast.forecastAmount.week.toInt',
        @Html(abTest.map (p => s"'dimension9':  '${p.toString}',").getOrElse(""))
        'dimension10': '@spSummary.numberOfQualifyingYears',
        'dimension11': '@spSummary.numberOfGaps',
        'dimension12': '@spSummary.numberOfGapsPayable',
        'dimension13': '@spSummary.yearsToContributeUntilPensionAge',
        'dimension14': '@spSummary.contractedOutFlag',
        'dimension15': '@spSummary.statePensionAge',
        'dimension16': '@spSummary.copeAmount.week',
        'dimension22': '@authenticationProvider',
        'metric5': 1
    });
}

@defining(Some(user)) { implicit userOption =>
    @nispMain(userLoggedIn = true, browserTitle = Messages("nisp.main.title"),
              articleClasses = Some("mainpage"), analyticsAdditionalJs = Some(analyticsAdditionalJs)) {

    <h1 class="heading-large">@Messages("nisp.main.h1.title")</h1>

@spSummary.forecast.scenario

    @if(spSummary.forecast.scenario.equals(Scenario.Reached)) {
        <div class="highlighted-event">
          <p> @Messages("nisp.main.basedOn") @Dates.formatDate(spSummary.statePensionAge.date.localDate) @Messages("nisp.main.whenYoullBe") @spSummary.statePensionAge.age, @Messages("nisp.main.estimate").toLowerCase() @Messages("nisp.is")</p>
          <p> <em>@NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.week")</em></p>
          <p> @NispMoney.pounds(spSummary.forecast.forecastAmount.month) @Messages("nisp.main.month"),
              @NispMoney.pounds(spSummary.forecast.forecastAmount.year) @Messages("nisp.main.year")
         </p>
    </div>
        <p>@Messages("nisp.main.estimate")</p>
        <ul class="list-bullet">
            <li>@Messages("nisp.main.notAGuarantee")</li>
            <li>@Messages("nisp.main.isBased",Dates.formatDate(spSummary.lastProcessedDate.localDate))</li>
            <li>@Messages("nisp.main.inflation")</li>
        </ul>
        <h3 class="heading-medium"> @NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.mostYouCanGet")</h3>
        <p>@Messages("nisp.main.cantImprove")</p>
        <p>@Messages("nisp.main.context.reachMax.needToPay", (spSummary.finalRelevantYear+1).toString())</p>
        <a href='@routes.NIRecordController.showGaps.url'>@Messages("nisp.main.showyourrecord")</a>

    }


    @if(spSummary.forecast.scenario.equals(Scenario.ContinueWorkingMax)) {
        <div class="highlighted-event">
            <p> @Messages("nisp.main.basedOn") @Dates.formatDate(spSummary.statePensionAge.date.localDate) @Messages("nisp.main.whenYoullBe") @spSummary.statePensionAge.age, @Messages("nisp.main.estimate").toLowerCase() @Messages("nisp.is")</p>
            <p> <em>@NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.week")</em></p>
            <p> @NispMoney.pounds(spSummary.forecast.forecastAmount.month) @Messages("nisp.main.month"),
                  @NispMoney.pounds(spSummary.forecast.forecastAmount.year) @Messages("nisp.main.year")
            </p>
        </div>
        @if(spSummary.numberOfQualifyingYears < Constants.minimumQualifyingYearsNSP) {
            <p>@Messages("nisp.main.estimate")</p>
            <ul class="list-bullet">
                <li>@Messages("nisp.main.notAGuarantee")</li>
                <li>@Messages("nisp.main.isBased",Dates.formatDate(spSummary.lastProcessedDate.localDate))</li>
                <li>@Messages("nisp.mqp.howManyToContribute",Time.years(spSummary.yearsToContributeUntilPensionAge))</li>
                <li>@Messages("nisp.main.inflation")</li>
            </ul>  
            <p> @Messages("nisp.mqp.youCurrentlyHave", spSummary.numberOfQualifyingYears,Constants.minimumQualifyingYearsNSP)</p> 
            <div class="panel-indent">
                <p>@Html(Messages("nisp.mqp.overseas"))</p>
            </div>
            <h3 class="heading-medium"> @NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.mostYouCanGet")</h3>
            <p>@Messages("nisp.mqp.cannotImprove")</p>
            <p>@Messages("nisp.main.after", Dates.formatDate(spSummary.statePensionAge.date.localDate))</p>
            <a href='@routes.NIRecordController.showGaps.url'>@Messages("nisp.main.showyourrecord")</a>
        } else {

            <p>@Messages("nisp.main.estimate")</p>
            <ul class="list-bullet">
                <li>@Messages("nisp.main.notAGuarantee")</li>
                <li>@Messages("nisp.main.inflation")</li>
            </ul>

            <h2 class="heading-medium">@Messages("nisp.main.h2.title")</h2>
            <div class="chart-block">
                <span>@Messages("nisp.main.chart.lastprocessed.title",spSummary.lastProcessedDate.localDate.getYear().toString())</span>
                <ul class="graph">
                    <li>
                     <span class="amount" style="width:@currentChart.width%">
                         <span>
                            @NispMoney.pounds(currentChart.amountModel.week) @Messages("nisp.main.chart.week")
                         </span>
                    </span>
                    </li>
                </ul>

            </div>

            <div class="chart-block">
                @if(spSummary.forecast.yearsLeftToWork == spSummary.yearsToContributeUntilPensionAge) {
                    <span>@Messages("nisp.main.chart.spa.title",(spSummary.finalRelevantYear+1).toString())</span>
                } else  {
                    @if(spSummary.forecast.yearsLeftToWork==1) {
                        <span>@Messages("nisp.main.chart.estimateIfYouContinue.single", spSummary.forecast.yearsLeftToWork, (spSummary.finalRelevantYear+1).toString())</span>
                    } else {
                        <span>@Messages("nisp.main.chart.estimateIfYouContinue.plural", spSummary.forecast.yearsLeftToWork, (spSummary.finalRelevantYear+1).toString())</span>
                    }

                }
                <ul class="graph">
                    <li>
                        <span class="amount" style="width:@forecastChart.width%">
                            <span>
                                @NispMoney.pounds(forecastChart.amountModel.week) @Messages("nisp.main.chart.week")
                            </span>
                        </span>
                    </li>
                </ul>
            </div>

            <h3 class="heading-medium"> @NispMoney.pounds(forecastChart.amountModel.week) @Messages("nisp.main.mostYouCanGet")</h3>
            @if(spSummary.forecast.yearsLeftToWork == spSummary.yearsToContributeUntilPensionAge) {
                <p>@Messages("nisp.main.after", (spSummary.finalRelevantYear+1).toString())</p>
            } else  {
                <p>@Messages("nisp.main.context.continueWorkingMax.stillNeedToPay", (spSummary.finalRelevantYear+1).toString()) </p>
            }

            <a href='@routes.NIRecordController.showGaps.url'>@Messages("nisp.main.showyourrecord")</a>
        }

    }

    @if(spSummary.forecast.scenario.equals(Scenario.ContinueWorkingNonMax)) {
        <div class="highlighted-event">
            <p> @Messages("nisp.main.basedOn") @Dates.formatDate(spSummary.statePensionAge.date.localDate) @Messages("nisp.main.whenYoullBe") @spSummary.statePensionAge.age, @Messages("nisp.main.estimate").toLowerCase() @Messages("nisp.is")</p>
            <p> <em>@NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.week")</em></p>
            <p> @NispMoney.pounds(spSummary.forecast.forecastAmount.month) @Messages("nisp.main.month"),
                @NispMoney.pounds(spSummary.forecast.forecastAmount.year) @Messages("nisp.main.year")
            </p>
        </div>
        @if(spSummary.numberOfQualifyingYears < Constants.minimumQualifyingYearsNSP) {
            <p>@Messages("nisp.main.estimate")</p>
            <ul class="list-bullet">
                <li>@Messages("nisp.main.notAGuarantee")</li>
                <li>@Messages("nisp.main.isBased",Dates.formatDate(spSummary.lastProcessedDate.localDate))</li>
                <li>@Messages("nisp.mqp.howManyToContribute",Time.years(spSummary.yearsToContributeUntilPensionAge))</li>
                <li>@Messages("nisp.main.inflation")</li>
            </ul>  
            <p> @Messages("nisp.mqp.youCurrentlyHave", Time.years(spSummary.numberOfQualifyingYears),Constants.minimumQualifyingYearsNSP)</p> 
            <div class="panel-indent">
                <p>@Html(Messages("nisp.mqp.overseas"))</p>
            </div>
            <h3 class="heading-medium"> @NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.mostYouCanGet")</h3>
            <p>@Messages("nisp.mqp.cannotImprove")</p>
            <p>@Messages("nisp.main.after", Dates.formatDate(spSummary.statePensionAge.date.localDate))</p>
            <a href='@routes.NIRecordController.showGaps.url'>@Messages("nisp.main.showyourrecord")</a>
        } else {
            <p>@Messages("nisp.main.estimate")</p>
            <ul class="list-bullet">
                <li>@Messages("nisp.main.notAGuarantee")</li>                
                <li>@Messages("nisp.main.inflation")</li>
            </ul>
             <h2 class="heading-medium">@Messages("nisp.main.h2.title")</h2>
            <div class="chart-block">
                <span>@Messages("nisp.main.chart.lastprocessed.title",spSummary.lastProcessedDate.localDate.getYear().toString())</span>
                <ul class="graph">
                    <li>
                     <span class="amount" style="width:@currentChart.width%">
                         <span>
                            @NispMoney.pounds(currentChart.amountModel.week) @Messages("nisp.main.chart.week")
                         </span>
                    </span>
                    </li>
                </ul>

            </div>

            <div class="chart-block">
                @if(spSummary.forecast.yearsLeftToWork == spSummary.yearsToContributeUntilPensionAge) {
                    <span>@Messages("nisp.main.chart.spa.title",(spSummary.finalRelevantYear+1).toString())</span>
                } else  {
                    @if(spSummary.forecast.yearsLeftToWork==1) {
                        <span>@Messages("nisp.main.chart.estimateIfYouContinue.single", spSummary.forecast.yearsLeftToWork, (spSummary.finalRelevantYear+1).toString())</span>
                    } else {
                        <span>@Messages("nisp.main.chart.estimateIfYouContinue.plural", spSummary.forecast.yearsLeftToWork, (spSummary.finalRelevantYear+1).toString())</span>
                    }

                }
                <ul class="graph">
                    <li>
                        <span class="amount" style="width:@forecastChart.width%">
                            <span>
                                @NispMoney.pounds(forecastChart.amountModel.week) @Messages("nisp.main.chart.week")
                            </span>
                        </span>
                    </li>
                </ul>
            </div>
            <h3 class="heading-medium"> @NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.mostYouCanGet")</h3>
            <p>@Messages("nisp.main.after", (spSummary.finalRelevantYear+1).toString())</p>
            <a href='@routes.NIRecordController.showGaps.url'>@Messages("nisp.main.showyourrecord")</a>

            @for(test <- abTest) {
                @if(test == B && spSummary.contractedOutFlag) {
                    <h3 class="heading-medium">@Messages("nisp.cope.title1")</h3>
                }
            }
        }
    }

    @if(spSummary.forecast.scenario.equals(Scenario.FillGaps)) {
        @if(spSummary.numberOfQualifyingYears < Constants.minimumQualifyingYearsNSP) {
            <h2 class="heading-medium">@Messages("nisp.mqp.reachStatePensionAge",Dates.formatDate(spSummary.statePensionAge.date.localDate),spSummary.statePensionAge.age)</h2>
            <div class="panel-indent">
                @Messages("nisp.mqp.youcurrentlyhaveUsing",Time.years(spSummary.numberOfQualifyingYears),spSummary.lastProcessedDate.localDate.getYear().toString())
            </div>
            <h2>@Messages("nisp.mqp.possible")</h2>
            <p>@Messages("nisp.mqp.youneedtoadd",(Time.years(Constants.minimumQualifyingYearsNSP-spSummary.numberOfQualifyingYears)), Time.years(spSummary.yearsToContributeUntilPensionAge), Dates.formatDate(spSummary.statePensionAge.date.localDate))</p>
            <p>@Messages("nisp.mqp.years.dontcount",Time.years(spSummary.numberOfGapsPayable))</p>
            <p>@Messages("nisp.mqp.afterspa",Dates.formatDate(spSummary.statePensionAge.date.localDate))</p>
            <a href='@routes.NIRecordController.showGaps.url'>@Messages("nisp.main.showyourrecord")</a>
            <div class="panel-indent">
                <p>@Html(Messages("nisp.mqp.overseas"))</p>
            </div>
        } else {
                <div class="highlighted-event">
                    <p> @Messages("nisp.main.basedOn") @Dates.formatDate(spSummary.statePensionAge.date.localDate) @Messages("nisp.main.whenYoullBe") @spSummary.statePensionAge.age, @Messages("nisp.main.estimate").toLowerCase() @Messages("nisp.is")</p>
                    <p> <em>@NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.week")</em></p>
                    <p> @NispMoney.pounds(spSummary.forecast.forecastAmount.month) @Messages("nisp.main.month"),
                        @NispMoney.pounds(spSummary.forecast.forecastAmount.year) @Messages("nisp.main.year")
                    </p>
                </div>
            <p>@Messages("nisp.main.estimate")</p>
            <ul class="list-bullet">
                <li>@Messages("nisp.main.notAGuarantee")</li>
                <li>@Messages("nisp.main.inflation")</li>
            </ul>
            <h2 class="heading-medium">@Messages("nisp.main.h2.title")</h2>
            <div class="chart-block">
                <span>@Messages("nisp.main.chart.lastprocessed.title",spSummary.lastProcessedDate.localDate.getYear().toString())</span>
                <ul class="graph">
                    <li>
                         <span class="amount" style="width:@currentChart.width%">
                             <span>
                                @NispMoney.pounds(currentChart.amountModel.week) @Messages("nisp.main.chart.week")
                             </span>
                        </span>
                    </li>
                </ul>
            </div>

            <div class="chart-block">
                <span>@Messages("nisp.main.chart.spa.title",(spSummary.finalRelevantYear+1).toString())</span>
                <ul class="graph">
                    <li>
                        <span class="amount" style="width:@forecastChart.width%">
                            <span>
                                @NispMoney.pounds(forecastChart.amountModel.week) @Messages("nisp.main.chart.week")
                            </span>
                        </span>
                    </li>
                </ul>
            </div>
            <h2 class="heading-medium">@Messages("nisp.main.context.fillGaps.improve.title")</h2>
            <h3>@Messages("nisp.main.context.fillGaps")</h3>
            <p>@Messages("nisp.main.context.improve.para1.plural")</p>
            <a href='@routes.NIRecordController.showGaps.url' role="button">@Messages("nisp.main.context.fillGaps.viewGaps")</a>
            <h3>@Messages("nisp.main.puttingOff")</h3>
            <p>@Messages("nisp.main.puttingOff.line1", spSummary.statePensionAge.age)</p>
            <a href="https://www.gov.uk/deferring-state-pension" target="_blank" rel="external">@Messages("nisp.main.puttingOff.linkTitle")</a>
        }    
    }
  }
}
