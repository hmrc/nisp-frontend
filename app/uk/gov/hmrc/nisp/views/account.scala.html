@*
* Copyright 2016 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@import uk.gov.hmrc.nisp.utils.Constants
@import uk.gov.hmrc.nisp.views.formatting.{NispMoney, Time}
@import uk.gov.hmrc.play.views.formatting.Dates
@import uk.gov.hmrc.nisp.models.{SPSummaryModel, SPChartModel}
@import uk.gov.hmrc.nisp.services.ABService
@import uk.gov.hmrc.nisp.models.enums.ABTest._
@import uk.gov.hmrc.nisp.controllers.auth.NispUser
@import uk.gov.hmrc.play.partials.CachedStaticHtmlPartialRetriever
@import uk.gov.hmrc.nisp.models.enums.Scenario
@import uk.gov.hmrc.nisp.controllers.routes
@import uk.gov.hmrc.nisp.utils.Constants

@(
    nino: String,
    spSummary: SPSummaryModel,
    abTest: Option[ABTest],
    currentChart: SPChartModel,
    forecastChart: SPChartModel,
    authenticationProvider: String,
    isPertaxUrl:Boolean
)(implicit request: Request[_], user: NispUser, partialRetriever: CachedStaticHtmlPartialRetriever)


@analyticsAdditionalJs = {
    ga('set', {
        'dimension8':  '@spSummary.forecast.forecastAmount.week.toInt',
        @Html(abTest.map (p => s"'dimension9':  '${p.toString}',").getOrElse(""))
        'dimension10': '@spSummary.numberOfQualifyingYears',
        'dimension11': '@spSummary.numberOfGaps',
        'dimension12': '@spSummary.numberOfGapsPayable',
        'dimension13': '@spSummary.yearsToContributeUntilPensionAge',
        'dimension14': '@spSummary.contractedOutFlag',
        'dimension15': '@spSummary.statePensionAge',
        'dimension16': '@spSummary.copeAmount.week',
        'dimension22': '@authenticationProvider',
        'metric5': 1
    });
}

@defining(Some(user)) { implicit userOption =>
    @nispMain(userLoggedIn = true, browserTitle = Messages("nisp.main.title"),
              articleClasses = Some("mainpage"), analyticsAdditionalJs = Some(analyticsAdditionalJs)) {

<h1 class="heading-large">@Messages("nisp.main.h1.title")</h1>

    @if(spSummary.numberOfQualifyingYears < Constants.minimumQualifyingYearsNSP)  {
        @spSummary.forecast.scenario match {

            case Scenario.ContinueWorkingMax | Scenario.ContinueWorkingNonMax  => {
                @includes.continueWorking(spSummary, currentChart, forecastChart)
            }


            case Scenario.FillGaps => {

                <h2 class="heading-medium">@Messages("nisp.mqp.reachStatePensionAge",Dates.formatDate(spSummary.statePensionAge.date.localDate),spSummary.statePensionAge.age)</h2>
                <div class="panel-indent">
                    @Messages("nisp.mqp.youcurrentlyhaveUsing",Time.years(spSummary.numberOfQualifyingYears),spSummary.lastProcessedDate.localDate.getYear().toString())
                </div>
                <h2>@Messages("nisp.mqp.possible")</h2>
                <p>@Messages("nisp.mqp.youneedtoadd",(Time.years(Constants.minimumQualifyingYearsNSP-spSummary.numberOfQualifyingYears)), Time.years(spSummary.yearsToContributeUntilPensionAge), Dates.formatDate(spSummary.statePensionAge.date.localDate))</p>
                <p>@Messages("nisp.mqp.years.dontcount",Time.years(spSummary.numberOfGapsPayable))</p>
                <p>@Messages("nisp.mqp.afterspa",Dates.formatDate(spSummary.statePensionAge.date.localDate))</p>
                <a href='@routes.NIRecordController.showGaps.url'>@Messages("nisp.main.showyourrecord")</a>
                <div class="panel-indent">
                    <p>@Html(Messages("nisp.mqp.overseas"))</p>
                </div>
            }
        }

    }else {

        <div class="highlighted-event">
            <p> @Messages("nisp.main.basedOn") @Dates.formatDate(spSummary.statePensionAge.date.localDate) @Messages("nisp.main.whenYoullBe") @spSummary.statePensionAge.age, @Messages("nisp.main.estimate").toLowerCase() @Messages("nisp.is")</p>
            <p> <em>@NispMoney.pounds(spSummary.forecast.forecastAmount.week) @Messages("nisp.main.week")</em></p>
            <p> @NispMoney.pounds(spSummary.forecast.forecastAmount.month) @Messages("nisp.main.month"),
                @NispMoney.pounds(spSummary.forecast.forecastAmount.year) @Messages("nisp.main.year")
            </p>
        </div>

       @if(spSummary.forecast.scenario.equals(Scenario.Reached)) {
            @includes.reached(spSummary)
       }

        @if(spSummary.forecast.scenario.equals(Scenario.ContinueWorkingMax) || spSummary.forecast.scenario.equals(Scenario.ContinueWorkingNonMax) ) {
            @includes.continueWorking(spSummary, currentChart, forecastChart)
        }

        @if(spSummary.forecast.scenario.equals(Scenario.FillGaps)) {
            @includes.fillGaps(spSummary, currentChart, forecastChart)
        }

        @for(test <- abTest) {
            @if(test == B && spSummary.contractedOutFlag) {
                <h3 class="heading-medium">@Messages("nisp.cope.title1")</h3>
                <p>@Html(Messages("nisp.cope.likeMostPeople", NispMoney.pounds(spSummary.forecast.forecastAmount.week)))</p>
                <p>@Html(Messages("nisp.cope.moreAbout",routes.AccountController.showCope.url))</p>
            }
        }
    <h3>>>>>@spSummary.forecast.scenario<<<</h3>
     }
}
}